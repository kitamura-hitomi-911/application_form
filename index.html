<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>申請フォーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div id="app"></div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    var form_data = [
        {
            group_label:'概要',
            units:[
                {
                    label: '大会名称',
                    id: 'tour_name',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'tour_name',
                            minlength: 3,
                            maxlength: 80,
                            is_required: true
                        }
                    ]
                },
                {
                    label: '想定参加者数',
                    id: 'participants_num',
                    items: [
                        {
                            type: 'number',
                            value: '',
                            name:'participants_num',
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'日時・場所',
            units:[
                {
                    label: '開催日時',
                    id: 'tour_date_time',
                    items: [
                        {
                            type: 'date',
                            value: '',
                            name:'tour_date[]',
                            is_required: true
                        },
                        {
                            type: 'time',
                            value: '',
                            name:'tour_time[]',
                            is_required: true
                        },
                    ]
                },
                {
                    label: '郵便番号',
                    id: 'postal_code',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'postal_code',
                            placeholder:'000-0000',
                            is_required: true
                        }
                    ]
                },
            ]
        }
    ];
</script>
<!-- ■コンポーネント群 ここから ■■■■■■■■■■■■ -->
<script>
    // form_item 共通の mixin
    var FormItemMixin = {
        props:{
            item:{
                type:Object,
                required:true
            }
        },
        computed:{
            value:{
                get(){
                    return this.item.value;
                },
                set(val){
                    this.$emit('update',{
                        name:this.item.name,
                        value:val
                    });
                }
            },
            err_msg(){
                return this.item.err_msgs.join('<br>');
            }
        }
    };
</script>
<script type="text/x-template" id="tmpl-app_form-input_time">
    <div class="form-item">
        <p class="form-item-ttl" v-if="item.label">{{item.label}}</p>
        <div class="form-time">
            <input type="time" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled">
        </div>
        <p class="form-err" v-if="err_msg" v-html="err_msg"></p>
    </div>
</script>
<script>
    Vue.component('FormInputTime',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_time'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_date">
    <div class="form-item">
        <p class="form-item-ttl" v-if="item.label">{{item.label}}</p>
        <div class="form-date">
            <input type="date" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :step="item.step" :disabled="item.disabled">
            <!-- UI上、min が今日より後だと、日付の入力がやりづらいので、input タグの min では指定しない -->
        </div>
        <p class="form-err" v-if="err_msg" v-html="err_msg"></p>
    </div>
</script>
<script>
    Vue.component('FormInputDate',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_date'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_number">
    <div class="form-item">
        <p class="form-item-ttl" v-if="item.label">{{item.label}}</p>
        <div class="form-number">
            <input type="number" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled">
        </div>
        <p class="form-err" v-if="err_msg" v-html="err_msg"></p>
    </div>
</script>
<script>
    Vue.component('FormInputNumber',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_number'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_text">
    <div class="form-item">
        <p class="form-item-ttl" v-if="item.label">{{item.label}}</p>
        <div class="form-text">
            <input type="text" :name="item.name" v-model="value" :placeholder="item.placeholder" :maxlength="item.maxlength" :minlength="item.minlength" :disabled="item.disabled">
        </div>
        <p class="form-err" v-if="err_msg" v-html="err_msg"></p>
    </div>
</script>
<script>
    Vue.component('FormInputText',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_text'
    });
</script>
<script type="text/x-template" id="tmpl-app_form">
    <div>
        <form action="./" method="post">
            <section class="form" v-for="unit_group in unit_groups" :key="unit_group.group_label">
                <h1>{{unit_group.group_label}}</h1>
                <div class="form-grp">
                    <template v-for="unit in unit_group.units">
                        <dl :class="{'is-required': unit.is_required}" :key="unit.id">
                            <dt>{{unit.label}}</dt>
                            <dd>
                                <component v-for="item in unit.items" :key="item.name" :is="item.component_name" :item="item" @update="update"></component>
                            </dd>
                        </dl>
                    </template>
                </div>
            </section>
        </form>
    </div>
</script>
<script>
    Vue.component('AppForm',{
        data(){
            return {
                unit_groups: []
            }
        },
        props:{
            form_data:{
                type:Array,
                required:true
            }
        },
        computed:{
            item_by_name(){
                return this.unit_groups.reduce((ret_obj, group) =>{
                    return group.units.reduce((acc,unit) => {
                        unit.items.forEach(item => {
                            acc[item.name] = item;
                        });
                        return acc;
                    },ret_obj);
                },{});
            }
        },
        created(){
            // unit_list をセット
            form_data.forEach(data=>{
                let _unit_group = {
                    group_label:data.group_label,
                    units:[]
                };
                data.units.forEach(unit=>{
                    const formated_form_unit_data = this.formatFormData(unit);
                    formated_form_unit_data && _unit_group.units.push(formated_form_unit_data);
                });
                _unit_group.units.length && this.unit_groups.push(_unit_group);

            });
        },
        template:'#tmpl-app_form',
        methods:{
            formatFormData(data){
                // unit のプロパティ
                const unit_props = {
                    required:['label','id','items'],
                    optional:[]
                };
                // item の コンポーネント名・プロパティ type別
                const settings_by_type = {
                    text:{
                        component_name:'FormInputText',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {pattern:null},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        }
                    },
                    number:{
                        component_name:'FormInputNumber',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        }
                    },
                    date:{
                        component_name:'FormInputDate',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        }
                    },
                    time:{
                        component_name:'FormInputTime',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        }
                    },
                    radio: {
                        component_name: 'FormInputRadio',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    checkbox: {
                        component_name: 'FormInputCheckbox',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    select: {
                        component_name: 'FormSelect',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    textarea: {
                        component_name: 'FormTextarea',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {disabled:false},
                                {is_required:false},
                                {err_msgs:[]}
                            ]
                        }
                    }

                };
                // エラーメッセージ デフォルト
                const default_err_msg_txt = {
                    empty_input:'入力必須です',
                    empty_select:'選択必須です',
                    min:'__MIN__以上の値を指定してください',
                    max:'__MAX__以下の値を指定してください',
                    minlength:'__MINLENGTH__文字以上入力してください',
                    maxlength:'__MAXLENGTH__文字以下で入力してください',
                    pattern:'不正なフォーマットです'
                };

                // unit の必須プロパティの不足チェック
                if(unit_props.required.some(prop=> data[prop] === void 0)){
                    console.error('Missing required property in form data',data);
                    return null;
                }
                // unit の任意プロパティのチェック
                unit_props.optional.forEach(prop_default => {
                    Object.keys(prop_default).forEach(key => {
                        if(data[key] === void 0){
                            data[key] = prop_default[key];
                        }
                    });
                });

                data.items.forEach(item => {

                    // item のプロパティチェック
                    const _item_props = settings_by_type[item.type].item_props;
                    // 必須
                    if(_item_props.required.some(prop => item[prop] === void 0)){
                        console.error('Missing required property in item data',item);
                    }
                    // 任意
                    _item_props.optional.forEach(prop_default => {
                        Object.keys(prop_default).forEach(key => {
                            if(item[key] === void 0){
                                item[key] = Array.isArray(prop_default[key])?[]:prop_default[key];
                            }
                        });
                    });

                    // item の component_name をセット
                    item.component_name = settings_by_type[item.type].component_name;

                    // item の err_msg_set をセット
                    item.err_msg_txt = Object.assign({}, default_err_msg_txt, item.err_msg_txt || {});

                    // item.list のプロパティのチェック
                    const _item_list_props = settings_by_type[item.type].item_list_props || '';
                    _item_list_props && item.list && item.list.forEach(list_item => {
                        // 必須
                        if(_item_list_props.required.some(prop => list_item[prop] === void 0)){
                            console.error('Missing required property in item.list data',item);
                        }
                        // 任意
                        _item_list_props.optional.forEach(prop_default => {
                            Object.keys(prop_default).forEach(key => {
                                if(list_item[key] === void 0){
                                    list_item[key] = Array.isArray(prop_default[key])?[]:prop_default[key];
                                }
                            });
                        });
                    });


                });

                // itemから算出したプロパティをunitに追加
                data.is_required = data.items.some(item => {
                    return item.is_required;
                });

                return data;
            }
        }
    });
</script>
<!-- ■コンポーネント群 ここまで ■■■■■■■■■■■■ -->
<script>
    (function () {
        "use strict";
        new Vue({
            el:'#app',
            data:{
                form_data:form_data
            },
            template:'<AppForm :form_data="form_data"></AppForm>',
        });
    })();
</script>
</body>
</html>