<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>申請フォーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div id="app"></div>
<script src="common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    var now = new Date("2020/04/10 12:01:12");// サーバサイドで今日の日付を埋め込み
    var form_data = [
        {
            group_label:'概要',
            units:[
                {
                    label: '大会名称',
                    id: 'tour_name',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'tour_name',
                            minlength: 3,
                            maxlength: 80,
                            is_required: true
                        }
                    ]
                },
                {
                    label: '紹介文',
                    id: 'description',
                    items: [
                        {
                            type: 'textarea',
                            value: '',
                            name:'description',
                            minlength: 5,
                            maxlength: 80,
                            is_required: true
                        }
                    ]
                },
                {
                    label: '想定参加者数',
                    id: 'participants_num',
                    items: [
                        {
                            type: 'number',
                            value: '',
                            name:'participants_num',
                            min: 5,
                            max: 1000,
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'日時・場所',
            units:[
                {
                    label: '開催日時',
                    id: 'tour_date_time',
                    items: [
                        {
                            type: 'date',
                            value: '',
                            name:'tour_date[]',
                            min:formatDate(now,'YYYY-MM-DD'),
                            max:formatDate(now,'YYYY')*1+1*1+'-'+formatDate(now,'MM-DD'),
                            is_required: true
                        },
                        {
                            type: 'time',
                            value: '',
                            name:'tour_time[]',
                            is_required: true
                        },
                    ],
                    can_duplicate:true
                },
                {
                    label: '郵便番号',
                    id: 'postal_code',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'postal_code',
                            placeholder:'000-0000',
                            pattern:'^[0-9]{3}-[0-9]{4}$',
                            is_required: true,
                            err_msg_txt:{
                                pattern:'000-0000のフォーマットで入力してください'
                            }
                        }
                    ]
                },
            ]
        },
        {
            group_label:'大会形式',
            units:[
                {
                    label: '大会形式',
                    id: 'tour_type',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'tour_type',
                            list: [
                                {
                                    label: '候補1',
                                    value: 1,
                                },
                                {
                                    label: '候補2',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        }
                    ]
                },
                {
                    label: 'タイトル',
                    id: 'title',
                    items: [
                        {
                            type: 'checkbox',
                            value: [],// checkbox で value で管理したいなら配列
                            name:'title',
                            list: [
                                {
                                    label: '候補1',
                                    value: 1,
                                },
                                {
                                    label: '候補2',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'費用',
            units:[
                {
                    label: '参加費',
                    id: 'fee',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'fee',
                            list: [
                                {
                                    label: 'なし',
                                    value: 1,
                                },
                                {
                                    label: 'あり',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        },
                        {
                            type: 'number',
                            value: '',
                            name:'fee_detail',
                            suf:'円',
                            min:0,
                            max:10000,
                            observe_items:[
                                {
                                    name: 'fee',
                                    changeCallback(observed_item) {
                                        // this が observer の この item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                },
                {
                    label: '賞品',
                    id: 'prize',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'prize',
                            list: [
                                {
                                    label: 'なし',
                                    value: 1,
                                },
                                {
                                    label: 'あり1',
                                    value: 2,
                                },
                                {
                                    label: 'あり2',
                                    value: 3,
                                },
                                {
                                    label: 'あり3',
                                    value: 4,
                                }
                            ],
                            is_required: true
                        },
                        {
                            label:'金額',
                            type: 'number',
                            value: '',
                            name:'prize_detail',
                            suf:'円',
                            min:0,
                            max:99999999,
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                },
                {
                    label: '提供者',
                    id: 'owner',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'owner',
                            is_required_if_valid: true,
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2 || observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                },
                {
                    label: '確認事項',
                    id: 'fee_agree',
                    items: [
                        {
                            type: 'checkbox',
                            value: [],
                            name:'fee_agree',
                            list: [
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る1',
                                    value: 1,
                                },
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る2',
                                    value: 2,
                                }
                            ],
                            is_required_all_select: true,
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2 || observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                }

            ]
        },
        {
            group_label:'セレクトテスト',
            units:[
                {
                    label: 'セレクトテスト',
                    id: 'select_test',
                    value:'',
                    items: [
                        {
                            type: 'select',
                            value: '1',
                            name:'select_test',
                            list: [
                                {
                                    label: '↓選択してください',
                                    value: '',
                                },
                                {
                                    label: '候補1',
                                    value: 1,
                                },
                                {
                                    label: '候補2',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        }
                    ]
                }
            ]
        },
        // 同意事項の group は confirm 画面では設定しない
        {
            group_label:'同意事項',
            units:[
                {
                    label: '同意事項',
                    id: 'agree',
                    items: [
                        {
                            type: 'checkbox',
                            value: [],
                            name:'agree',
                            not_send:true,
                            list: [
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る1',
                                    value: 1,
                                },
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る2',
                                    value: 2,
                                },
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る3',
                                    value: 3,
                                }
                            ],
                            is_required_all_select: true
                        }
                    ],
                }
            ]
        }

    ];
</script>
<!-- ■コンポーネント群 ここから ■■■■■■■■■■■■ -->
<script>
    // form_item 共通の mixin
    var FormItemMixin = {
        props:{
            item:{
                type:Object,
                required:true
            },
            mode:{
                type:String,
                required:true
            }
        },
        computed:{
            value:{
                get(){
                    return this.item.value;
                },
                set(val){
                    this.$emit('update',{
                        name:this.item.name,
                        value:val
                    });
                }
            },
            name(){
                return this.item.not_send ? null : this.item.name;
            },
            class_name(){
                return this.mode === 'edit' ? this.item.class_name : 'view_parts';
            }
        }
    };
</script>
<script type="text/x-template" id="tmpl-app_form-select">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <template v-if="mode==='edit'">
            <div :class="item.class_name+'-item'">
                <p :class="item.class_name+'-label'">{{lebel_selected}}</p>
                <select :name="name" v-model="value" :disabled="item.disabled">
                    <option :value="option.value" v-for="option in item.list" :key="option.value" :disabled="option.disabled">{{option.label}}</option>
                </select>
            </div>
        </template>
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormSelect',{
        mixins:[FormItemMixin],
        computed:{
            lebel_selected(){
                return this.item.list.reduce((acc,option)=> {
                    return option.value == this.item.value ? option.label : acc;
                },'');
            },
            value_label() {
                return this.lebel_selected || '(未選択)';
            }
        },
        template:'#tmpl-app_form-select'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-textarea">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <textarea :name="name" v-model="value" :placeholder="item.placeholder" :maxlength="item.maxlength" :minlength="item.minlength" :disabled="item.disabled" v-if="mode==='edit'"></textarea>
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
    </div>
</script>
<script>
    Vue.component('FormTextarea',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-textarea',
        computed: {
            value_label() {
                return this.item.value ? this.item.value : '(未入力)';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_checkbox">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <template v-if="mode==='edit'">
            <p :class="item.class_name+'item'" v-for="checkbox in item.list" :key="checkbox.value">
                <input type="checkbox" :name="name" v-model="value" :value="checkbox.value" :id="item.name+'_'+checkbox.value" :disabled="item.disabled || checkbox.disabled">
                <label :for="item.name+'_'+checkbox.value">{{checkbox.label}}</label>
            </p>
        </template>
        <span class="form-item-label" v-if="mode==='view'" v-html="value_label"></span>
    </div>
</script>
<script>
    Vue.component('FormInputCheckbox',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_checkbox',
        computed: {
            value_label() {
                return this.item.value.length ? this.item.list.reduce((value_label_ary, checkbox)=>{
                    this.item.value.some( value => {
                        // 数値が文字列になると Array.indexOfでチェックできないので
                        if(value == checkbox.value){
                            value_label_ary.push(checkbox.label);
                            return true;
                        }
                        return false;
                    });
                    return value_label_ary;
                },[]).join('<br>') : '(未選択)';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_radio">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <template v-if="mode==='edit'">
            <p :class="item.class_name+'item'" v-for="radio in item.list" :key="radio.value">
                <input type="radio" :name="name" v-model="value" :value="radio.value" :id="item.name+'_'+radio.value" :disabled="item.disabled || radio.disabled">
                <label :for="item.name+'_'+radio.value">{{radio.label}}</label>
            </p>
        </template>
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputRadio',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_radio',
        computed: {
            value_label() {
                return this.item.list.reduce((value_label, radio)=>{
                    return radio.value == this.item.value ? radio.label : value_label;
                },'(未選択)');
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_time">
    <div :class="class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="time" :name="name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled" v-if="mode==='edit'">
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputTime',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_time',
        computed: {
            value_label() {
                return this.item.value ? this.item.value : '--:--';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_date">
    <div :class="class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="date" :name="name" v-model="value" :placeholder="item.placeholder" :max="item.max" :step="item.step" :disabled="item.disabled" v-if="mode==='edit'">
        <!-- UI上、min が今日より後だと、日付の入力がやりづらいので、input タグの min では指定しない -->
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputDate',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_date',
        computed: {
            value_label() {
                return this.item.value ? formatDate(this.item.value,'YYYY/MM/DD') : '----/--/--';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_number">
    <div :class="class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="number" :name="name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled" v-if="mode==='edit'">
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputNumber',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_number',
        computed: {
            value_label() {
                return this.item.value ? this.item.value : '-';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_text">
    <div :class="class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="text" :name="name" v-model="value" :placeholder="item.placeholder" :maxlength="item.maxlength" :minlength="item.minlength" :disabled="item.disabled" v-if="mode==='edit'">
        <span class="form-item-label" v-if="mode==='view'">{{value_label}}</span>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputText',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_text',
        computed: {
            value_label() {
                return this.item.value ? this.item.value : '(未入力)';
            }
        }
    });
</script>
<script type="text/x-template" id="tmpl-app_form">
    <div>
        <form :action="action" method="get" name="frm"><!-- 値が見やすいように一時的にget -->
            <section class="form" v-for="unit_group in unit_groups" :key="unit_group.group_label">
                <h1>{{unit_group.group_label}}</h1>
                <div class="form-grp">
                    <template v-for="unit in unit_group.units">
                        <dl :class="unit.class_name" :key="unit.id">
                            <dt v-if="!unit.is_duplicated">{{unit.label}}</dt>
                            <dd>
                                <component v-for="item in unit.items" :key="item.name" :is="item.component_name" :item="item" @update="update" :mode="mode"></component>
                                <p class="form-error" v-if="unit.err_msgs.length" v-html="unit.err_msgs.join('<br>')"></p>
                            </dd>
                            <dd v-if="unit.is_duplicated"><a href="#" @click.prevent="removeUnit(unit)">削除</a></dd>
                            <dd v-if="unit.can_duplicate"><a href="#" @click.prevent="addUnit(unit)">{{unit.label}}追加</a></dd>
                        </dl>
                    </template>
                </div>
            </section>
            <section class="form_btns">
                <p class="btn"><a href="#" @click.prevent="onClickSubmit">送信</a></p>
            </section>
        </form>
    </div>
</script>
<script>
    Vue.component('AppForm',{
        data(){
            return {
                unit_groups: [],
                observed_item:{},
                default_err_msg_txt:{
                    empty_input:'入力必須です',
                    empty_select:'選択必須です',
                    min:'__MIN__以上の値を指定してください',
                    max:'__MAX__以下の値を指定してください',
                    min_date:'__MIN__以降の日を入力してください',
                    max_date:'__MAX__以前の日を入力してください',
                    min_time:'__MIN__以降の時間を入力してください',
                    max_time:'__MAX__以前の時間を入力してください',
                    minlength:'__MINLENGTH__文字以上入力してください',
                    maxlength:'__MAXLENGTH__文字以下で入力してください',
                    pattern:'不正なフォーマットです',
                    all_select:'すべて選択必須です'
                }
            }
        },
        props:{
            form_data:{
                type:Array,
                required:true
            },
            mode:{
                type:String,
                required:true
            },
            action:{
                type:String,
                required:true
            }
        },
        computed:{
            item_by_id(){
                return this.unit_groups.reduce((ret_obj, group) =>{
                    return group.units.reduce((acc,unit) => {
                        unit.items.forEach(item => {
                            acc[item.id] = item;
                        });
                        return acc;
                    },ret_obj);
                },{});
            }
        },
        created(){
            // unit_list をセット
            form_data.forEach(data=>{
                let _unit_group = {
                    group_label:data.group_label,
                    units:[]
                };
                data.units.forEach(unit=>{
                    const formated_form_unit_data = this.formatFormData(unit);
                    formated_form_unit_data && _unit_group.units.push(formated_form_unit_data);
                });
                _unit_group.units.length && this.unit_groups.push(_unit_group);

            });

            // ovserved_item をセット
            this.unit_groups.forEach(group => {
                group.units.forEach(unit => {
                    unit.items.forEach(item => {
                        item.observe_items !== void 0 && Array.isArray(item.observe_items) && item.observe_items.forEach(observe_item => {
                            if (!this.observed_item[observe_item.name]) {
                                this.observed_item[observe_item.name] = [];
                            }
                            this.observed_item[observe_item.name].push({
                                _this:item,
                                callback:observe_item.changeCallback,
                            });
                            // 初期処理が true だったら処理
                            if(observe_item.init){
                                observe_item.changeCallback.call(item, this.item_by_id[observe_item.name]);
                            }

                        });
                    });
                });
            });
        },
        template:'#tmpl-app_form',
        methods:{
            update(update_obj){
                if(Array.isArray(this.item_by_id[update_obj.name].value)){
                    // 配列の場合は1回リセットして入れなおす
                    this.item_by_id[update_obj.name].value.splice(0);
                    Array.isArray(update_obj.value) && update_obj.value.forEach(update_value => {
                        this.item_by_id[update_obj.name].value.push(update_value);
                    });

                }else{
                    this.item_by_id[update_obj.name].value = update_obj.value;
                }

                // ovserved_item があれば処理
                this.observed_item[update_obj.name] && this.observed_item[update_obj.name].forEach( observer =>{
                    observer.callback.call(observer._this,update_obj);
                });
            },
            formatFormData(data){
                // unit のプロパティ
                const unit_props = {
                    required:['label','id','items'],
                    optional:[
                        {err_msgs:[]}
                    ]
                };
                // item の コンポーネント名・プロパティ type別
                const settings_by_type = {
                    text:{
                        component_name:'FormInputText',
                        class_name:'input_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {pattern:null},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        }
                    },
                    number:{
                        component_name:'FormInputNumber',
                        class_name:'input_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        }
                    },
                    date:{
                        component_name:'FormInputDate',
                        class_name:'date_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        }
                    },
                    time:{
                        component_name:'FormInputTime',
                        class_name:'time_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        }
                    },
                    radio: {
                        component_name: 'FormInputRadio',
                        class_name:'radio_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    checkbox: {
                        component_name: 'FormInputCheckbox',
                        class_name:'checkbox_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {is_required_all_select:false},
                                {not_send:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    select: {
                        component_name: 'FormSelect',
                        class_name:'select_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    textarea: {
                        component_name: 'FormTextarea',
                        class_name:'textarea_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {disabled:false},
                                {is_required:false},
                                {is_required_if_valid:false},
                                {not_send:false}
                            ]
                        }
                    }

                };

                // unit の必須プロパティの不足チェック
                if(unit_props.required.some(prop=> data[prop] === void 0)){
                    console.error('Missing required property in form data',data);
                    return null;
                }
                // unit の任意プロパティのチェック
                unit_props.optional.forEach(prop_default => {
                    Object.keys(prop_default).forEach(key => {
                        if(data[key] === void 0){
                            this.$set(data, key, prop_default[key]);
                        }
                    });
                });

                data.items.forEach(item => {

                    // item のプロパティチェック
                    const _item_props = settings_by_type[item.type].item_props;
                    // 必須
                    if(_item_props.required.some(prop => item[prop] === void 0)){
                        console.error('Missing required property in item data',item);
                    }
                    // 任意
                    _item_props.optional.forEach(prop_default => {
                        Object.keys(prop_default).forEach(key => {
                            if(item[key] === void 0){
                                this.$set(item, key, prop_default[key]);
                            }
                        });
                    });

                    // item の id をセット
                    this.$set(item, 'id', item.name);

                    // item の component_name をセット（リアクティブである必要はないのでそのまま代入）
                    item.component_name = settings_by_type[item.type].component_name;

                    // item の class_name をセット（リアクティブである必要はないのでそのまま代入）
                    item.class_name = settings_by_type[item.type].class_name;

                    // item.list のプロパティのチェック
                    const _item_list_props = settings_by_type[item.type].item_list_props || '';
                    _item_list_props && item.list && item.list.forEach(list_item => {
                        // 必須
                        if(_item_list_props.required.some(prop => list_item[prop] === void 0)){
                            console.error('Missing required property in item.list data',item);
                        }
                        // 任意
                        _item_list_props.optional.forEach(prop_default => {
                            Object.keys(prop_default).forEach(key => {
                                if(list_item[key] === void 0){
                                    this.$set(list_item, key, prop_default[key]);
                                }
                            });
                        });
                    });


                });

                // itemから算出したプロパティをunitに追加
                data.is_required = data.items.some(item => {
                    return item.is_required;
                });
                let _class_name = {
                    'is_required':data.is_required
                };
                _class_name['form-unit-'+data.id] = true;
                data.class_name = _class_name;

                return data;
            },
            /**
             * エラーメッセージを返す
             * @param {string} エラーの種類
             * @param {Object} item チェック対象のitem
             * @return {string} エラーメッセージ
             */
            _getErrMsg(err_type,item){
                let err_msg = '';
                let err_msg_txt = Object.assign({}, this.default_err_msg_txt, item.err_msg_txt || {});
                if(err_type === 'empty'){
                    err_type = (item.type === 'radio' || item.type === 'checkbox' || item.type === 'select') ? 'empty_select' : 'empty_input';
                }
                if(err_type === 'min' || err_type === 'max'){
                    err_type = (item.type === 'date' || item.type === 'time') ? err_type + '_' + item.type : err_type;
                }
                err_msg = err_msg_txt[err_type];
                if(err_type === 'min' || err_type === 'min_date' || err_type === 'min_time'){
                    let replace_str = item.type === 'date' ? formatDate(item.min,'YYYY/MM/DD') : item.min;
                    err_msg = err_msg_txt[err_type].replace(/__MIN__/g,replace_str);
                }
                if(err_type === 'max' || err_type === 'max_date' || err_type === 'max_time'){
                    let replace_str = item.type === 'date' ? formatDate(item.max,'YYYY/MM/DD') : item.max;
                    err_msg = err_msg_txt[err_type].replace(/__MAX__/g,replace_str);
                }
                if(err_type === 'minlength'){
                    err_msg = err_msg_txt[err_type].replace(/__MINLENGTH__/g,item.minlength);
                }
                if(err_type === 'maxlength'){
                    err_msg = err_msg_txt[err_type].replace(/__MAXLENGTH__/g,item.maxlength);
                }

                return err_msg;
            },
            /**
             * 未入力チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrEmpty(item){
                return !item.disabled && (item.is_required || item.is_required_if_valid) && (Array.isArray(item.value) && !item.value.length || !Array.isArray(item.value) && !item.value);
            },
            /**
             * min チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrMin(item){
                return !item.disabled && !Array.isArray(item.value) && item.value !== '' && item.min !== void 0 && item.min !== null && item.value < item.min;
            },
            /**
             * max チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrMax(item){
                return !item.disabled && !Array.isArray(item.value) && item.value !== '' && item.max !== void 0 && item.max !== null && item.value > item.max;
            },
            /**
             * minlength チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrMinlength(item){
                return !item.disabled && !Array.isArray(item.value) && item.value !== '' && item.minlength !== void 0 && item.minlength !== null && item.value.length < item.minlength;
            },
            /**
             * maxlength チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrMaxlength(item){
                return !item.disabled && !Array.isArray(item.value) && item.value !== '' && item.maxlength !== void 0 && item.maxlength !== null && item.value.length > item.maxlength;
            },
            /**
             * pattern チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrPattern(item){
                let ret = false;
                if(!item.disabled && !Array.isArray(item.value) && item.value !== '' && item.pattern !== void 0 && item.pattern){
                    let reg = new RegExp(item.pattern);
                    if(!item.value.match(reg)){
                        ret = true;
                    }
                }
                return ret;
            },
            /**
             * all_select チェック
             * @param {Object} item チェック対象のitem
             * @return {boolean} エラーがあるか否か
             */
            _hasErrAllSelect(item){
                return !item.disabled && Array.isArray(item.value) && item.is_required_all_select !== void 0 && item.is_required_all_select && item.value.length !== item.list.length;
            },
            addUnit(base_unit){
                let clone_unit = {};
                Object.keys(base_unit).forEach(unit_key => {
                    if(Array.isArray(base_unit[unit_key])){
                        /* items, err_msgs */
                        clone_unit[unit_key] = [];
                        unit_key === 'items' && base_unit[unit_key].forEach(item => {
                            clone_unit[unit_key].push(Object.assign({}, item));
                        });
                    }else if(base_unit[unit_key] instanceof Object){
                        /* class_name */
                        clone_unit[unit_key] = Object.assign({}, base_unit[unit_key]);
                    }else{
                        clone_unit[unit_key] = base_unit[unit_key];
                    }
                });
                clone_unit.is_duplicated = true;
                clone_unit.items.forEach(item => {
                    item.id += '_';
                });

                this.unit_groups.forEach(group => {
                    let add_index = group.units.reduce((add_index, unit,index) => {
                        return unit.id === clone_unit.id ? index : add_index;
                    },void 0);
                    if(add_index !== void 0){
                        clone_unit.id += '_';
                        group.units.splice(++add_index, 0, clone_unit);
                    }
                });
            },
            removeUnit(tgt_unit){

            },
            onClickSubmit(){
                // 入力内容チェック
                let err_flg = this.unit_groups.reduce((group_err_flg, group) => {
                    return group.units.reduce((err_flg, unit) => {
                        // エラー初期化
                        let _already_empty_err = false; // unit内の未入力エラーメッセージは1つにする
                        unit.err_msgs.splice(0);

                        unit.items.forEach(item => {
                            // 未入力チェック
                            this._hasErrEmpty(item) && !_already_empty_err && (_already_empty_err = true) && unit.err_msgs.push(this._getErrMsg('empty',item));

                            // min チェック
                            this._hasErrMin(item) && unit.err_msgs.push(this._getErrMsg('min',item));

                            // max チェック
                            this._hasErrMax(item) && unit.err_msgs.push(this._getErrMsg('max',item));

                            // minlength チェック
                            this._hasErrMinlength(item) && unit.err_msgs.push(this._getErrMsg('minlength',item));

                            // maxlength チェック
                            this._hasErrMaxlength(item) && unit.err_msgs.push(this._getErrMsg('maxlength',item));

                            // pattern チェック
                            this._hasErrPattern(item) && unit.err_msgs.push(this._getErrMsg('pattern',item));

                            // 全選択チェック
                            this._hasErrAllSelect(item) && unit.err_msgs.push(this._getErrMsg('all_select',item));
                        });

                        return !!unit.err_msgs.length || err_flg;
                    },group_err_flg);
                },false);

                if(!err_flg){
                    console.log('エラーがないのでsubmit');
                    document.frm.submit();
                }
            }
        }
    });
</script>
<!-- ■コンポーネント群 ここまで ■■■■■■■■■■■■ -->
<script>
    (function () {
        "use strict";
        new Vue({
            el:'#app',
            data:{
                form_data:form_data,
                mode:'edit',/* edit | view */
                action:'./'
            },
            template:'<AppForm :form_data="form_data" :mode="mode" :action="action"></AppForm>',
        });
    })();
</script>
</body>
</html>