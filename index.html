<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>申請フォーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div id="app"></div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    var form_data = [
        {
            group_label:'概要',
            units:[
                {
                    label: '大会名称',
                    id: 'tour_name',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'tour_name',
                            minlength: 3,
                            maxlength: 80,
                            is_required: true
                        }
                    ]
                },
                {
                    label: '紹介文',
                    id: 'description',
                    items: [
                        {
                            type: 'textarea',
                            value: '',
                            name:'description',
                            minlength: 5,
                            maxlength: 80,
                            is_required: true
                        }
                    ]
                },
                {
                    label: '想定参加者数',
                    id: 'participants_num',
                    items: [
                        {
                            type: 'number',
                            value: '',
                            name:'participants_num',
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'日時・場所',
            units:[
                {
                    label: '開催日時',
                    id: 'tour_date_time',
                    items: [
                        {
                            type: 'date',
                            value: '',
                            name:'tour_date[]',
                            is_required: true
                        },
                        {
                            type: 'time',
                            value: '',
                            name:'tour_time[]',
                            is_required: true
                        },
                    ]
                },
                {
                    label: '郵便番号',
                    id: 'postal_code',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'postal_code',
                            placeholder:'000-0000',
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'大会形式',
            units:[
                {
                    label: '大会形式',
                    id: 'tour_type',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'tour_type',
                            list: [
                                {
                                    label: '候補1',
                                    value: 1,
                                },
                                {
                                    label: '候補2',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        }
                    ]
                },
                {
                    label: 'タイトル',
                    id: 'title',
                    items: [
                        {
                            type: 'checkbox',
                            value: [],// checkbox で value で管理したいなら配列
                            name:'title',
                            list: [
                                {
                                    label: '候補1',
                                    value: 1,
                                },
                                {
                                    label: '候補2',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        }
                    ]
                },
            ]
        },
        {
            group_label:'費用',
            units:[
                {
                    label: '参加費',
                    id: 'fee',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'fee',
                            list: [
                                {
                                    label: 'なし',
                                    value: 1,
                                },
                                {
                                    label: 'あり',
                                    value: 2,
                                }
                            ],
                            is_required: true
                        },
                        {
                            type: 'text',
                            value: '',
                            name:'fee_detail',
                            suf:'円',
                            observe_items:[
                                {
                                    name: 'fee',
                                    changeCallback(observed_item) {
                                        // this が observer の この item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                },
                {
                    label: '賞品',
                    id: 'prize',
                    items: [
                        {
                            type: 'radio',
                            value: '',
                            name:'prize',
                            list: [
                                {
                                    label: 'なし',
                                    value: 1,
                                },
                                {
                                    label: 'あり1',
                                    value: 2,
                                },
                                {
                                    label: 'あり2',
                                    value: 3,
                                },
                                {
                                    label: 'あり3',
                                    value: 4,
                                }
                            ],
                            is_required: true
                        },
                        {
                            label:'金額',
                            type: 'text',
                            value: '',
                            name:'prize_detail',
                            suf:'円',
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                },
                {
                    label: '提供者',
                    id: 'owner',
                    items: [
                        {
                            type: 'text',
                            value: '',
                            name:'owner',
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2 || observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        },
                        {
                            type: 'checkbox',
                            value: [],
                            name:'owner_agree',
                            list: [
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る1',
                                    value: 1,
                                },
                                {
                                    label: '同意事項文章入る同意事項文章入る同意事項文章入る同意事項文章入る2',
                                    value: 2,
                                }
                            ],
                            observe_items:[
                                {
                                    name: 'prize',
                                    changeCallback(observed_item) {
                                        // this が observer のこの item 自身。またここはアロー関数では動作しない
                                        this.disabled = !(observed_item.value*1 === 2 || observed_item.value*1 === 3 || observed_item.value*1 === 4);
                                    },
                                    init: true
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ];
</script>
<!-- ■コンポーネント群 ここから ■■■■■■■■■■■■ -->
<script>
    // form_item 共通の mixin
    var FormItemMixin = {
        props:{
            item:{
                type:Object,
                required:true
            }
        },
        computed:{
            value:{
                get(){
                    return this.item.value;
                },
                set(val){
                    this.$emit('update',{
                        name:this.item.name,
                        value:val
                    });
                }
            }
        }
    };
</script>
<script type="text/x-template" id="tmpl-app_form-select">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <div :class="item.class_name+'-item'">
            <p :class="item.class_name+'-label'">{{lebel_selected}}</p>
            <select :name="item.name" v-model="value" :disabled="item.disabled">
                <option :value="option.value" v-for="option in item.list" :key="option.value" :disabled="option.disabled">{{option.label}}</option>
            </select>
        </div>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormSelect',{
        mixins:[FormItemMixin],
        computed:{
            lebel_selected(){
                return this.item.list.reduce((acc,option)=> {
                    return option.value == this.item.value ? option.label : acc;
                },'');
            }
        },
        template:'#tmpl-app_form-select'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-textarea">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <textarea :name="item.name" v-model="value" :placeholder="item.placeholder" :maxlength="item.maxlength" :minlength="item.minlength" :disabled="item.disabled"></textarea>
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormTextarea',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-textarea'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_checkbox">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <p :class="item.class_name+'item'" v-for="checkbox in item.list" :key="checkbox.value">
            <input type="checkbox" :name="item.name" v-model="value" :value="checkbox.value" :id="item.name+'_'+checkbox.value" :disabled="item.disabled || checkbox.disabled">
            <label :for="item.name+'_'+checkbox.value">{{checkbox.label}}</label>
        </p>
    </div>
</script>
<script>
    Vue.component('FormInputCheckbox',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_checkbox'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_radio">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <p :class="item.class_name+'item'" v-for="radio in item.list" :key="radio.value">
            <input type="radio" :name="item.name" v-model="value" :value="radio.value" :id="item.name+'_'+radio.value" :disabled="item.disabled || radio.disabled">
            <label :for="item.name+'_'+radio.value">{{radio.label}}</label>
        </p>
    </div>
</script>
<script>
    Vue.component('FormInputRadio',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_radio'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_time">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="time" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled">
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputTime',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_time'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_date">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="date" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :step="item.step" :disabled="item.disabled">
        <!-- UI上、min が今日より後だと、日付の入力がやりづらいので、input タグの min では指定しない -->
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputDate',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_date'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_number">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="number" :name="item.name" v-model="value" :placeholder="item.placeholder" :max="item.max" :min="item.min" :step="item.step" :disabled="item.disabled">
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputNumber',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_number'
    });
</script>
<script type="text/x-template" id="tmpl-app_form-input_text">
    <div :class="item.class_name">
        <span class="form-item-ttl" v-if="item.label">{{item.label}}</span>
        <input type="text" :name="item.name" v-model="value" :placeholder="item.placeholder" :maxlength="item.maxlength" :minlength="item.minlength" :disabled="item.disabled">
        <span class="form-item-suf" v-if="item.suf">{{item.suf}}</span>
    </div>
</script>
<script>
    Vue.component('FormInputText',{
        mixins:[FormItemMixin],
        template:'#tmpl-app_form-input_text'
    });
</script>
<script type="text/x-template" id="tmpl-app_form">
    <div>
        <form action="./" method="post">
            <section class="form" v-for="unit_group in unit_groups" :key="unit_group.group_label">
                <h1>{{unit_group.group_label}}</h1>
                <div class="form-grp">
                    <template v-for="unit in unit_group.units">
                        <dl :class="unit.class_name" :key="unit.id">
                            <dt>{{unit.label}}</dt>
                            <dd>
                                <component v-for="item in unit.items" :key="item.name" :is="item.component_name" :item="item" @update="update"></component>
                                <p class="form-error" v-if="unit.err_msgs.length" v-html="unit.err_msgs.join('<br>')"></p>
                            </dd>
                        </dl>
                    </template>
                </div>
            </section>
        </form>
    </div>
</script>
<script>
    Vue.component('AppForm',{
        data(){
            return {
                unit_groups: [],
                observed_item:{},
                default_err_msg_txt:{
                    empty_input:'入力必須です',
                    empty_select:'選択必須です',
                    min:'__MIN__以上の値を指定してください',
                    max:'__MAX__以下の値を指定してください',
                    minlength:'__MINLENGTH__文字以上入力してください',
                    maxlength:'__MAXLENGTH__文字以下で入力してください',
                    pattern:'不正なフォーマットです'
                }
            }
        },
        props:{
            form_data:{
                type:Array,
                required:true
            }
        },
        computed:{
            item_by_name(){
                return this.unit_groups.reduce((ret_obj, group) =>{
                    return group.units.reduce((acc,unit) => {
                        unit.items.forEach(item => {
                            acc[item.name] = item;
                        });
                        return acc;
                    },ret_obj);
                },{});
            }
        },
        created(){
            // unit_list をセット
            form_data.forEach(data=>{
                let _unit_group = {
                    group_label:data.group_label,
                    units:[]
                };
                data.units.forEach(unit=>{
                    const formated_form_unit_data = this.formatFormData(unit);
                    formated_form_unit_data && _unit_group.units.push(formated_form_unit_data);
                });
                _unit_group.units.length && this.unit_groups.push(_unit_group);

            });

            // ovserved_item をセット
            this.unit_groups.forEach(group => {
                group.units.forEach(unit => {
                    unit.items.forEach(item => {
                        item.observe_items !== void 0 && Array.isArray(item.observe_items) && item.observe_items.forEach(observe_item => {
                            console.log(observe_item);
                            if (!this.observed_item[observe_item.name]) {
                                this.observed_item[observe_item.name] = [];
                            }
                            this.observed_item[observe_item.name].push({
                                _this:item,
                                callback:observe_item.changeCallback,
                            });
                            // 初期処理が true だったら処理
                            if(observe_item.init){
                                observe_item.changeCallback.call(item, this.item_by_name[observe_item.name]);
                            }

                        });
                    });
                });
            });
        },
        template:'#tmpl-app_form',
        methods:{
            update(update_obj){
                if(Array.isArray(this.item_by_name[update_obj.name].value)){
                    // 配列の場合は1回リセットして入れなおす
                    this.item_by_name[update_obj.name].value.splice(0);
                    Array.isArray(update_obj.value) && update_obj.value.forEach(update_value => {
                        this.item_by_name[update_obj.name].value.push(update_value);
                    });

                }else{
                    this.item_by_name[update_obj.name].value = update_obj.value;
                }

                // ovserved_item があれば処理
                this.observed_item[update_obj.name] && this.observed_item[update_obj.name].forEach( observer =>{
                    observer.callback.call(observer._this,update_obj);
                });
            },
            formatFormData(data){
                // unit のプロパティ
                const unit_props = {
                    required:['label','id','items'],
                    optional:[
                        {err_msgs:[]}
                    ]
                };
                // item の コンポーネント名・プロパティ type別
                const settings_by_type = {
                    text:{
                        component_name:'FormInputText',
                        class_name:'input_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {pattern:null},
                                {disabled:false},
                                {is_required:false}
                            ]
                        }
                    },
                    number:{
                        component_name:'FormInputNumber',
                        class_name:'input_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false}
                            ]
                        }
                    },
                    date:{
                        component_name:'FormInputDate',
                        class_name:'date_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false}
                            ]
                        }
                    },
                    time:{
                        component_name:'FormInputTime',
                        class_name:'time_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {max:null},
                                {min:null},
                                {step:null},
                                {disabled:false},
                                {is_required:false}
                            ]
                        }
                    },
                    radio: {
                        component_name: 'FormInputRadio',
                        class_name:'radio_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    checkbox: {
                        component_name: 'FormInputCheckbox',
                        class_name:'checkbox_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    select: {
                        component_name: 'FormSelect',
                        class_name:'select_parts',
                        item_props:{
                            required:['name','type','list','value'],
                            optional:[
                                {label:''},
                                {disabled:false},
                                {is_required:false}
                            ]
                        },
                        item_list_props:{
                            required:['label','value'],
                            optional:[
                                {disabled:false}
                            ]
                        }
                    },
                    textarea: {
                        component_name: 'FormTextarea',
                        class_name:'textarea_parts',
                        item_props:{
                            required:['name','type','value'],
                            optional:[
                                {label:''},
                                {placeholder:''},
                                {maxlength:null},
                                {minlength:null},
                                {disabled:false},
                                {is_required:false}
                            ]
                        }
                    }

                };
                // エラーメッセージ デフォルト
                const default_err_msg_txt = {
                    empty_input:'入力必須です',
                    empty_select:'選択必須です',
                    min:'__MIN__以上の値を指定してください',
                    max:'__MAX__以下の値を指定してください',
                    minlength:'__MINLENGTH__文字以上入力してください',
                    maxlength:'__MAXLENGTH__文字以下で入力してください',
                    pattern:'不正なフォーマットです'
                };

                // unit の必須プロパティの不足チェック
                if(unit_props.required.some(prop=> data[prop] === void 0)){
                    console.error('Missing required property in form data',data);
                    return null;
                }
                // unit の任意プロパティのチェック
                unit_props.optional.forEach(prop_default => {
                    Object.keys(prop_default).forEach(key => {
                        if(data[key] === void 0){
                            this.$set(data, key, prop_default[key]);
                        }
                    });
                });

                data.items.forEach(item => {

                    // item のプロパティチェック
                    const _item_props = settings_by_type[item.type].item_props;
                    // 必須
                    if(_item_props.required.some(prop => item[prop] === void 0)){
                        console.error('Missing required property in item data',item);
                    }
                    // 任意
                    _item_props.optional.forEach(prop_default => {
                        Object.keys(prop_default).forEach(key => {
                            if(item[key] === void 0){
                                this.$set(item, key, prop_default[key]);
                            }
                        });
                    });

                    // item の component_name をセット
                    item.component_name = settings_by_type[item.type].component_name;

                    // item の class_name をセット
                    item.class_name = settings_by_type[item.type].class_name;

                    // item の err_msg_set をセット
                    item.err_msg_txt = Object.assign({}, default_err_msg_txt, item.err_msg_txt || {});

                    // item.list のプロパティのチェック
                    const _item_list_props = settings_by_type[item.type].item_list_props || '';
                    _item_list_props && item.list && item.list.forEach(list_item => {
                        // 必須
                        if(_item_list_props.required.some(prop => list_item[prop] === void 0)){
                            console.error('Missing required property in item.list data',item);
                        }
                        // 任意
                        _item_list_props.optional.forEach(prop_default => {
                            Object.keys(prop_default).forEach(key => {
                                if(list_item[key] === void 0){
                                    this.$set(list_item, key, prop_default[key]);
                                }
                            });
                        });
                    });


                });

                // itemから算出したプロパティをunitに追加
                data.is_required = data.items.some(item => {
                    return item.is_required;
                });
                let _class_name = {
                    'is_required':data.is_required
                };
                _class_name['form-unit-'+data.id] = true;
                data.class_name = _class_name;

                return data;
            }
        }
    });
</script>
<!-- ■コンポーネント群 ここまで ■■■■■■■■■■■■ -->
<script>
    (function () {
        "use strict";
        new Vue({
            el:'#app',
            data:{
                form_data:form_data
            },
            template:'<AppForm :form_data="form_data"></AppForm>',
        });
    })();
</script>
</body>
</html>